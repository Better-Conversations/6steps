networks:
  postgres:
    external: true

services:
  web:
    image: ghcr.io/better-conversations/6steps:latest
    ports:
      - "80:80"
    environment:
      - RAILS_ENV=production
      # - DATABASE_URL=postgresql://user:password@db:5432/sixsteps_production
      - RAILS_MASTER_KEY=your_rails_master_key_here
      - SECRET_KEY_BASE=your_secret_key_base_here
      - RAILS_LOG_TO_STDOUT=1
      - RAILS_SERVE_STATIC_FILES=1
      - ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=your_encryption_primary_key_here
      - ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=your_encryption_deterministic_key_here
      - ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=your_encryption_salt_here
      - SENTRY_DSN=https://your_key@your_org.ingest.sentry.io/your_project_id
      - APPLICATION_HOST=your.domain.com
      - MAILER_FROM_ADDRESS=hello@your.domain.com
      - POSTMARK_API_TOKEN=your_postmark_api_token_here
    volumes:
      - rails_storage:/rails/storage
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/up || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - postgres

  jobs:
    image: ghcr.io/better-conversations/6steps:latest
    command: bundle exec rails solid_queue:start
    environment:
      - RAILS_ENV=production
      # - DATABASE_URL=postgresql://user:password@db:5432/sixsteps_production
      - RAILS_MASTER_KEY=your_rails_master_key_here
      - SECRET_KEY_BASE=your_secret_key_base_here
      - SENTRY_DSN=https://your_key@your_org.ingest.sentry.io/your_project_id
      - RAILS_LOG_TO_STDOUT=1
      - RAILS_SERVE_STATIC_FILES=1
      - ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=your_encryption_primary_key_here
      - ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=your_encryption_deterministic_key_here
      - ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=your_encryption_salt_here
      - POSTMARK_API_TOKEN=your_postmark_api_token_here
      - APPLICATION_HOST=your.domain.com
      - MAILER_FROM_ADDRESS=hello@your.domain.com
    networks:                                                                                                                               
      - postgres                                                                                                                             

volumes:
  rails_storage:
