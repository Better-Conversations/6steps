<% content_for :title, "Session Details - Six Steps" %>

<div class="max-w-3xl mx-auto">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div class="flex items-center">
      <div class="<%= space_color_class(@session.current_space) %> w-12 h-12 rounded-full flex items-center justify-center">
        <%= space_icon(@session.current_space) %>
      </div>
      <div class="ml-4">
        <h1 class="text-2xl font-bold text-slate-900">
          <%= @session.current_space&.titleize %> Space
        </h1>
        <p class="text-slate-500">
          <%= @session.created_at.strftime("%B %d, %Y at %H:%M") %>
        </p>
      </div>
    </div>

    <div class="flex items-center space-x-2">
      <% if @session.completed? %>
        <%= link_to export_pdf_journey_session_path(@session), class: "inline-flex items-center px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 bg-white hover:bg-slate-50" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Export PDF
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Session summary -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4">Session Summary</h2>

    <div class="grid sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-slate-50 rounded-lg p-4">
        <p class="text-sm text-slate-500">Status</p>
        <p class="font-medium">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= session_state_class(@session.state) %>">
            <%= @session.state.titleize %>
          </span>
        </p>
      </div>
      <div class="bg-slate-50 rounded-lg p-4">
        <p class="text-sm text-slate-500">Iterations</p>
        <p class="font-medium text-slate-900"><%= @session.iteration_count %> of 6</p>
      </div>
      <div class="bg-slate-50 rounded-lg p-4">
        <p class="text-sm text-slate-500">Duration</p>
        <p class="font-medium text-slate-900">
          <% if @session.started_at && @session.completed? %>
            <%= distance_of_time_in_words(@session.started_at, @session.updated_at) %>
          <% else %>
            --
          <% end %>
        </p>
      </div>
    </div>

    <% if @session.session_summary.present? %>
      <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
        <p class="text-sm text-purple-600 font-medium mb-2">Integration Insight</p>
        <p class="text-slate-700 italic">"<%= @session.session_summary %>"</p>
      </div>
    <% end %>
  </div>

  <!-- Reflection journey -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-6">Reflection Journey</h2>

    <% if @iterations.any? %>
      <div class="space-y-6">
        <% @iterations.each do |iteration| %>
          <div class="relative pl-8 pb-6 border-l-2 border-violet-200 last:border-l-0 last:pb-0">
            <div class="absolute -left-2 top-0 w-4 h-4 rounded-full bg-violet-500"></div>

            <div class="bg-slate-50 rounded-lg p-4">
              <p class="text-sm text-violet-600 font-medium mb-2">Step <%= iteration.iteration_number %></p>

              <div class="mb-3">
                <p class="text-sm text-slate-500 mb-1">Question</p>
                <p class="text-slate-700 italic">"<%= iteration.question_asked %>"</p>
              </div>

              <div>
                <p class="text-sm text-slate-500 mb-1">Your Response</p>
                <p class="text-slate-900"><%= iteration.user_response %></p>
              </div>

              <% if iteration.reflected_words.present? %>
                <div class="mt-3 pt-3 border-t border-slate-200">
                  <p class="text-xs text-slate-500">
                    Key words: <span class="text-violet-600"><%= iteration.reflected_words %></span>
                  </p>
                </div>
              <% end %>

              <% if iteration.safety_intervention.present? %>
                <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded text-sm text-amber-800">
                  <p><%= iteration.safety_intervention %></p>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-slate-500 text-center py-8">No iterations recorded for this session.</p>
    <% end %>
  </div>

  <!-- Privacy notice -->
  <div class="bg-violet-50 border border-violet-200 rounded-lg p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="ml-3 text-sm text-violet-700">
        <p>
          <strong>Privacy note:</strong> Your reflection content will be automatically redacted after 30 days.
          Session metadata (date, space, iterations) will be preserved.
        </p>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="flex justify-between items-center">
    <%= link_to session_history_index_path, class: "text-sm text-violet-600 hover:text-violet-700" do %>
      &larr; Back to History
    <% end %>

    <%= button_to "Delete Session",
        session_history_path(@session),
        method: :delete,
        data: { turbo_confirm: "Are you sure you want to delete this session? This cannot be undone." },
        class: "text-sm text-purple-600 hover:text-purple-700" %>
  </div>
</div>
